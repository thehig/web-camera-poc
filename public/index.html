<html>
  <body>
    <style>
      a {
        text-align: center;
        display: block;
      }

      .hidden {
        display: none;
      }
    </style>

    <div id="screenshot" style="text-align:center;">
      <a
        href="https://github.com/thehig/web-camera-poc/blob/master/public/index.html"
        >Source</a
      >
      <p>Click buttons or image to toggle between camera and snapshot</p>
      <video class="videostream" autoplay=""></video>
      <img id="screenshot-img" />
      <p><button id="btnCapture">Capture video</button></p>
      <p><button id="btnScreenshot" disabled="">Take screenshot</button></p>
    </div>

    <script type="text/javascript">
      const btnCapture = document.querySelector("#btnCapture");
      const btnScreenshot = document.querySelector("#btnScreenshot");
      const video = document.querySelector("#screenshot video");
      const img = document.querySelector("#screenshot img");
      const canvas = document.createElement("canvas");

      function startStream(stream) {
        // Connect stream to video element
        video.srcObject = stream;

        // Show appropriate UI state
        btnCapture.disabled = true;
        btnScreenshot.disabled = false;
        video.classList.remove("hidden");
        img.classList.add("hidden");
      }

      function stopStream() {
        if (!video.srcObject) return; // Stream hasn't been started

        // Stop stream
        video.srcObject.getTracks()[0].stop();

        // Show appropriate UI state
        btnCapture.disabled = false;
        btnScreenshot.disabled = true;
        video.classList.add("hidden");
        img.classList.remove("hidden");
      }

      function uploadImage() {
        var http = new XMLHttpRequest();
        var url = "/api/images";
        http.open("POST", url, true);

        http.setRequestHeader("Content-Type", "application/json");

        http.onreadystatechange = function() {
          //Call a function when the state changes.
          if (http.readyState == 4 && http.status == 200) {
            alert(http.responseText);
          }
        };

        http.send(JSON.stringify({ value: img.src }));
      }

      // Alert error
      function handleError(err) {
        console.log(err);
        alert(err);
      }

      // Initialize camera feed
      btnCapture.onclick = img.onclick = function() {
        navigator.mediaDevices
          .getUserMedia({ video: true })
          .then(startStream)
          .catch(handleError);
      };

      // Take screenshot
      btnScreenshot.onclick = video.onclick = function() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        // draw video to canvas
        canvas.getContext("2d").drawImage(video, 0, 0);
        // draw canvas to image
        img.src = canvas.toDataURL("image/webp");

        stopStream();
        uploadImage();
      };
    </script>
  </body>
</html>
