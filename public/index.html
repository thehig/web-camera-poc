<html>
  <body>
    <style>
      a {
        text-align: center;
        display: block;
      }

      .hidden {
        display: none;
      }
    </style>

    <div id="screenshot" style="text-align:center;">
      <a
        href="https://github.com/thehig/web-camera-poc/blob/master/public/index.html"
        >Source</a
      >
      <p>Click buttons or image to toggle between camera and snapshot</p>
      <video class="videostream" autoplay=""></video>
      <img id="screenshot-img" />
      <p><button id="btnCapture">Capture video</button></p>
      <p><button id="btnScreenshot" disabled="">Take screenshot</button></p>
      <p><button id="btnSwitchCamera">Switch Camera</button></p>
    </div>

    <script type="text/javascript">
      // ███████╗██╗     ███████╗███╗   ███╗███████╗███╗   ██╗████████╗███████╗
      // ██╔════╝██║     ██╔════╝████╗ ████║██╔════╝████╗  ██║╚══██╔══╝██╔════╝
      // █████╗  ██║     █████╗  ██╔████╔██║█████╗  ██╔██╗ ██║   ██║   ███████╗
      // ██╔══╝  ██║     ██╔══╝  ██║╚██╔╝██║██╔══╝  ██║╚██╗██║   ██║   ╚════██║
      // ███████╗███████╗███████╗██║ ╚═╝ ██║███████╗██║ ╚████║   ██║   ███████║
      // ╚══════╝╚══════╝╚══════╝╚═╝     ╚═╝╚══════╝╚═╝  ╚═══╝   ╚═╝   ╚══════╝

      const video = document.querySelector("#screenshot video");
      const img = document.querySelector("#screenshot img");
      const btnCapture = document.querySelector("#btnCapture");
      const btnScreenshot = document.querySelector("#btnScreenshot");
      const btnSwitchCamera = document.querySelector("#btnSwitchCamera");
      const canvas = document.createElement("canvas");

      //  ██████╗ ██████╗ ███╗   ██╗███████╗████████╗██████╗  █████╗ ██╗███╗   ██╗████████╗███████╗
      // ██╔════╝██╔═══██╗████╗  ██║██╔════╝╚══██╔══╝██╔══██╗██╔══██╗██║████╗  ██║╚══██╔══╝██╔════╝
      // ██║     ██║   ██║██╔██╗ ██║███████╗   ██║   ██████╔╝███████║██║██╔██╗ ██║   ██║   ███████╗
      // ██║     ██║   ██║██║╚██╗██║╚════██║   ██║   ██╔══██╗██╔══██║██║██║╚██╗██║   ██║   ╚════██║
      // ╚██████╗╚██████╔╝██║ ╚████║███████║   ██║   ██║  ██║██║  ██║██║██║ ╚████║   ██║   ███████║
      //  ╚═════╝ ╚═════╝ ╚═╝  ╚═══╝╚══════╝   ╚═╝   ╚═╝  ╚═╝╚═╝  ╚═╝╚═╝╚═╝  ╚═══╝   ╚═╝   ╚══════╝

      let front = true;
      let constraints;

      // Configure the constraints & UI
      function configureCamera() {
        // Reference: https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia
        constraints = {
          video: {
            width: { min: 776, ideal: 720, max: 1080 },
            height: { min: 1024, ideal: 1280, max: 1920 },
            facingMode: front ? "user" : "environment"
          }
        };

        btnSwitchCamera.innerText =
          "Switch Camera. (Currently " + constraints.video.facingMode + ")";
      }

      // ██╗   ██╗██╗    ███████╗████████╗ █████╗ ████████╗███████╗
      // ██║   ██║██║    ██╔════╝╚══██╔══╝██╔══██╗╚══██╔══╝██╔════╝
      // ██║   ██║██║    ███████╗   ██║   ███████║   ██║   █████╗
      // ██║   ██║██║    ╚════██║   ██║   ██╔══██║   ██║   ██╔══╝
      // ╚██████╔╝██║    ███████║   ██║   ██║  ██║   ██║   ███████╗
      //  ╚═════╝ ╚═╝    ╚══════╝   ╚═╝   ╚═╝  ╚═╝   ╚═╝   ╚══════╝

      function showCameraRunningUI() {
        btnCapture.disabled = true;
        btnScreenshot.disabled = false;
        // btnSwitchCamera.disabled = true;
        video.classList.remove("hidden");
        img.classList.add("hidden");
      }

      function showCameraStoppedUI() {
        btnCapture.disabled = false;
        btnScreenshot.disabled = true;
        // btnSwitchCamera.disabled = false;
        video.classList.add("hidden");
        img.classList.remove("hidden");
      }

      // ███████╗████████╗██████╗ ███████╗ █████╗ ███╗   ███╗
      // ██╔════╝╚══██╔══╝██╔══██╗██╔════╝██╔══██╗████╗ ████║
      // ███████╗   ██║   ██████╔╝█████╗  ███████║██╔████╔██║
      // ╚════██║   ██║   ██╔══██╗██╔══╝  ██╔══██║██║╚██╔╝██║
      // ███████║   ██║   ██║  ██║███████╗██║  ██║██║ ╚═╝ ██║
      // ╚══════╝   ╚═╝   ╚═╝  ╚═╝╚══════╝╚═╝  ╚═╝╚═╝     ╚═╝
      // Connect stream to video element
      function startStream() {
        return navigator.mediaDevices
          .getUserMedia(constraints)
          .then(stream => {
            video.srcObject = stream;
            showCameraRunningUI();
          })
          .catch(err => {
            console.log(err);
            showCameraStoppedUI();
            alert(err);
          });
      }

      // stop() the video source track
      function stopStream() {
        if (!video.srcObject) return; // Stream hasn't been started
        return video.srcObject.getTracks()[0].stop();
      }

      //  █████╗  ██████╗████████╗██╗ ██████╗ ███╗   ██╗███████╗
      // ██╔══██╗██╔════╝╚══██╔══╝██║██╔═══██╗████╗  ██║██╔════╝
      // ███████║██║        ██║   ██║██║   ██║██╔██╗ ██║███████╗
      // ██╔══██║██║        ██║   ██║██║   ██║██║╚██╗██║╚════██║
      // ██║  ██║╚██████╗   ██║   ██║╚██████╔╝██║ ╚████║███████║
      // ╚═╝  ╚═╝ ╚═════╝   ╚═╝   ╚═╝ ╚═════╝ ╚═╝  ╚═══╝╚══════╝

      // Render video frame to data url
      function snapshotVideo() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        // draw video to canvas
        canvas.getContext("2d").drawImage(video, 0, 0);
        // draw canvas to image
        return canvas.toDataURL("image/webp");
      }

      // XHR POST value as JSON to '/api/images'
      function upload(value) {
        var http = new XMLHttpRequest();
        var url = "/api/images";
        http.open("POST", url, true);

        http.setRequestHeader("Content-Type", "application/json");

        http.onreadystatechange = function() {
          //Call a function when the state changes.
          if (http.readyState == 4 && http.status == 200) {
            alert(http.responseText);
          }
        };

        http.send(JSON.stringify({ value: value }));
      }

      //  ██████╗ ███╗   ██╗     ██████╗██╗     ██╗ ██████╗██╗  ██╗
      // ██╔═══██╗████╗  ██║    ██╔════╝██║     ██║██╔════╝██║ ██╔╝
      // ██║   ██║██╔██╗ ██║    ██║     ██║     ██║██║     █████╔╝
      // ██║   ██║██║╚██╗██║    ██║     ██║     ██║██║     ██╔═██╗
      // ╚██████╔╝██║ ╚████║    ╚██████╗███████╗██║╚██████╗██║  ██╗
      //  ╚═════╝ ╚═╝  ╚═══╝     ╚═════╝╚══════╝╚═╝ ╚═════╝╚═╝  ╚═╝

      // Start camera stream
      btnCapture.onclick = img.onclick = function() {
        startStream();
      };
      // Take screenshot & upload
      btnScreenshot.onclick = video.onclick = function() {
        let source = snapshotVideo();
        img.src = source;
        showCameraStoppedUI();
        stopStream();
        upload(source);
      };
      // Handle camera switching
      btnSwitchCamera.onclick = function() {
        front = !front;
        configureCamera();
        stopStream().then(() => {
          startStream();
          showCameraRunningUI();
        });
      };
      
      // ██╗███╗   ██╗██╗████████╗██╗ █████╗ ██╗         ███████╗████████╗ █████╗ ████████╗███████╗
      // ██║████╗  ██║██║╚══██╔══╝██║██╔══██╗██║         ██╔════╝╚══██╔══╝██╔══██╗╚══██╔══╝██╔════╝
      // ██║██╔██╗ ██║██║   ██║   ██║███████║██║         ███████╗   ██║   ███████║   ██║   █████╗  
      // ██║██║╚██╗██║██║   ██║   ██║██╔══██║██║         ╚════██║   ██║   ██╔══██║   ██║   ██╔══╝  
      // ██║██║ ╚████║██║   ██║   ██║██║  ██║███████╗    ███████║   ██║   ██║  ██║   ██║   ███████╗
      // ╚═╝╚═╝  ╚═══╝╚═╝   ╚═╝   ╚═╝╚═╝  ╚═╝╚══════╝    ╚══════╝   ╚═╝   ╚═╝  ╚═╝   ╚═╝   ╚══════╝
      showCameraStoppedUI();
      configureCamera();
    </script>
  </body>
</html>
